define("common:widget/ui/sugHistory/sugHistory",function(t){function e(t){this.options=s.extend(n,t||{}),this.kw=s("#kw")[0],window.sugrecno=-1,this.pageName=this.options.page||"",this.pageQuery=this.options.query||"",this.sampleKey=this.options.samplekey||""}var s=t("common:widget/ui/base/base"),i=t("common:widget/ui/statistic/statistic"),o=t("common:widget/ui/utils/utils"),n={container:'<div id="SugHistory"><div id="SugRecBox"><div id="SugContent"></div><div class="sug-history-clean-box" id="sugHistoryCleanBox"><a href="javascript:void(0);" class="sug-history-clean" id="SugHistoryClean">清空历史记录</a></div></div></div>',historyKey:"indexPageSugList",cleanHistoryStatus:"cleanHistoryStatus",protocol:location.protocol,host:location.host,path:"search/index",fm:"index",fr:"sughistory",urlParams:"tn=baiduimage&ipn=r&ct=201326592&cl=2&lm=-1&st=-1&sf=1&fmq=&pv=&ic=0&nc=1&z=&se=1&showtab=0&fb=0&width=&height=&face=0&istype=2&ie=utf-8"},r=!1;return s.extend(e.prototype,{init:function(t){this.renderList({data:t}),this.bindOnceEvent()},renderList:function(t){var e=s.extend({},t||{}),i=[];if(e.data)i=e.data;else{var o=e.historyKey||this.options.historyKey;i=s.cookie.get(o),i=i?s.json.parse(i):[]}var n=[];this.listLen=i.length,this.fomatData(i,n),0===s("#SugHistory").length&&s(document.body).append(this.options.container);this.sug=s("#SugHistory"),this.$historyCleanBox=s("#sugHistoryCleanBox"),this.$historySugContent=this.sug.find("#SugContent"),1811103===this.pageName&&this.sug.addClass("homeSugHistory");for(var r=[],a=0,u=Math.min(n.length,9);u>a;a++)r.push('<a class="sugline" data-name="sug" target="_blank" href="'+n[a].url+'" ><div class="suginner"><span class="sugs" >'+this.strSub(n[a].query,0,52,"…")+'</span><span class="delete-sug" data-text="'+n[a].query+'">删除</span></div></a>');s("#SugContent").html(r.join("")),this.updateWithListLen(),this.bindSugEvent(),this.sug.hide()},strSub:function(t,e,s,i){if(!t)return"";if(e>=t.length)return"";i="undefined"==typeof i?"":i,e=0>e?0:e;for(var o=0,n=0,r="",a=t.length,n=0;a>n;n++)if(!(e>n)){if(o=t.charCodeAt(n)>255?o+2:o+1,o>s)return r+i;r+=t.charAt(n)}return r},fomatData:function(t,e){for(var s=t||[],i=this.options,n=window.query&&query.dyTabStr?"&dyTabStr="+query.dyTabStr:"",r=0,a=s.length;a>r;r++){var u={};u.url=i.path+"?"+i.urlParams+"&fm="+i.fm+"&pos=history&word="+encodeURIComponent(s[r])+n,u.query=o.escapeHTML(s[r]),u.flag=s[r],e.push(u)}},overItem:function(t){s(t).addClass("sughover")},selectItem:function(){},keydown:function(t){if(!this.sug.is(":hidden")){var e=t.keyCode||t.which;if(13===e||38===e||40===e){var i=s(".sughover",this.sug),o=s(".sugline",this.sug),n=o.length;if(13===e){if(t.stopPropagation(t),t.preventDefault(t),i.length>0)return void setTimeout(function(){window.location.href=i[0].href},0)}else if(38===e)window.sugrecno--;else{if(40!==e)return;window.sugrecno++}this.kw.value="",window.sugrecno<0&&(window.sugrecno=0),window.sugrecno>n-1&&(window.sugrecno=n-1),i.length>0&&i.eq(0).removeClass("sughover"),this.overItem(s(".sugline",this.sug)[window.sugrecno])}}},enter:function(t){if(this.kw=t.target||t.srcElement,this.kw.value.length>0)this.sug&&this.close();else{var e=s.cookie.get(this.options.historyKey);if(e=e?s.json.parse(e):[],0===e.length)return this.sug.hide(),!1;this.render.call(this)}},render:function(){return 1===parseInt(s.cookie.get(this.options.cleanHistoryStatus),10)?!1:("none"===this.sug.css("display")&&i&&i(null,1811103,{p:this.pageName,q:this.pageQuery,samplekey:this.sampleKey}),r||this.renderList(),r=!1,this.update(),void this.sug.show())},update:function(){var t=s(this.kw).parent(),e=t.offset(),i=(this.options.offsetL||8,0);this.sug.css("left",e.left+"px"),1811103===this.pageName?this.sug.outerWidth(t.outerWidth()):this.sug.width(t.width()),1811103===this.pageName&&(i-=this.options.$homeEl.offset().top),this.sug.css("top",e.top+t.outerHeight()+i+(s.browser.ie?-2:0)-8+"px")},close:function(){this.sug.hide(),window.sugrecno=-1},blur:function(){},bindOnceEvent:function(){{var t=this,e=s("#SugHistory");s("#sttb")}e.on("click",function(t){t.stopPropagation()}),s("#kw").on("mousedown",function(e){t.enter(e)}).on("keyup",function(e){t.enter(e)}).on("keydown",function(e){r=8!==e.keyCode?!0:!1,t.keydown(e)}).parent().on("click",function(t){t.stopPropagation()});var i=s("#kw3");i.length>0&&i.on("mousedown",function(e){t.enter(e)}).on("keyup",function(e){t.enter(e)}).on("keydown",function(e){r=8!==e.keyCode?!0:!1,t.keydown(e)}).parent().on("click",function(t){t.stopPropagation(t)}),s(document).on("click",function(e){t.close(e)}),s(window).on("scroll",function(e){t.close(e)})},bindSugEvent:function(){{var t=this;s(".sugline",this.sug).on("mouseout",function(){s(this).removeClass("sughover"),window.sugrecno=-1}).on("mouseover",function(){s(this).addClass("sughover"),window.sugrecno=0})}s(".delete-sug",this.sug).on("click",function(e){e.stopPropagation(e),e.preventDefault(e);var i=s(this).attr("data-text");s(this).closest(".sugline").remove(),t.deleteHistoryItem(i)}),s("#SugHistoryClean").on("click",function(e){s.cookie.set(t.options.cleanHistoryStatus,1,{path:"/"}),t.cleanHistory(),t.close(e)}),s(document).on("dragover",function(e){t.close(e)})},parseHistory:function(t){for(var e={},s=0,i=t.length;i>s;s++)e[t[s]]=s;return e},deleteHistoryItem:function(t){var e=this.getRecord(),i=this.parseHistory(e),o=i[t];e.splice(o,1),s.cookie.set(this.options.historyKey,s.json.stringify(e.slice(0,9)),{path:"/",expires:7776e3}),this.listLen-=1,this.updateWithListLen()},getRecord:function(){var t=s.cookie.get(this.options.historyKey);return t?s.json.parse(t):[]},cleanHistory:function(){return s.cookie.set(this.options.historyKey,s.json.stringify([]),{path:"/"}),!0},updateWithListLen:function(){var t=this.$historySugContent,e=this.listLen;5>e?t.addClass("few"):t.removeClass("few"),4>e?this.$historyCleanBox.hide():this.$historyCleanBox.show(),4>e?t.addClass("rare"):t.removeClass("rare"),0===e&&this.sug.hide()}}),e});