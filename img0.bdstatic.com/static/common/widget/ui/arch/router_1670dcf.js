define("common:widget/ui/arch/router",function(e){function t(e){this.rules=[],this.model=e,this._actions={},this.currentAction=null,this._ruleKeys={};var t=this;this._modelUpdateHandler=function(e){if(e&&e.keys&&e.keys.length){for(var n=e.keys,r=!1,i=n.length-1;i>=0;i--)if(t._ruleKeys[n[i]]){r=!0;break}r&&t.dispatch()}},e.addEventListener("changed",this._modelUpdateHandler)}var n=e("common:widget/ui/base/base");return n.extend(t.prototype,{addRule:function(e,t){this.rules.push({rule:e,action:t}),this._recordRuleKeys([e])},addRules:function(e){e&&e.length&&(this.rules=this.rules.concat(e),this._recordRuleKeys(e))},_recordRuleKeys:function(e){if(e)for(var t,n=e.length-1;n>=0;n--){t=e[n];for(var r in t)t.hasOwnProperty(r)&&(this._ruleKeys[r]=!0)}},loadAction:function(t){var r=new n.Deferred,i=this,s=this._actions[t];return s?r.resolve(s):e.async(t,function(e){s="function"==typeof e?new e(i.model):e,i._actions[t]=s,r.resolve(s)}),r},checkRule:function(e){if(e){var t=!0,n=this.model;for(var r in e)if(e.hasOwnProperty(r)&&(t=n.get(r)==e[r],!t))break;return t}return!1},dispatch:function(){for(var e,t=this.rules,n=this.model,r=0;r<t.length;r++)if(e=t[r],this.checkRule(e.rule)){this.loadAction(e.action).then(function(t){t&&t!=this.currentAction&&(this.currentAction=t,t.process(n,e.rule))});break}}}),t});