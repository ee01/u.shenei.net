<?php  if(!defined('IN_UCHOME')) { exit('Access Denied'); }  
$multi_mode=true; $perpage = 10; $page = empty($_GET['page'])?1:intval($_GET['page']); if($page<1) $page=1; $start = ($page-1)*$perpage; if(empty($_SCONFIG['networkpage'])) $start = 0;  
ckstart($start, $perpage);  
$cache_file = ''; $cache_time = $_SCONFIG['topcachetime']; if($cache_time<5) $cache_time = 5; $fuids = array(); $count = 0; $now_pos = 0; if(!in_array($_GET['view'], array('online','mm','gg','credit','experience','friendnum','viewnum','updatetime'))) $_GET['view'] = 'show'; if ($_GET['view'] == 'show') { $c_sql = "\x53EL\x45\x43\124 COUNT(*) \x46ROM ".tname('show'); $sql = "SE\x4c\x45\x43\x54 space.*, \x66\151eld.*, m\x61\151\156.* \106\122OM ".tname('show')." \x6d\141\x69n
		LEFT JOIN ".tname('space')." space \x4f\x4e space.uid=m\x61\x69n.uid
		LEFT JOIN ".tname('spacefield')." \x66\151e\154\x64 \x4f\x4e fi\145\x6cd.uid=\x6d\x61in.uid
		ORDER BY \x6dai\x6e.credit DESC";  
if(substr($_SGLOBAL['timestamp'], -1) == '0') { $_SGLOBAL['db']->query("DELETE \x46R\117\x4d ".tname('show')." WHERE credit<1"); 
}  
$space['showcredit'] = getcount('show', array('uid'=>$space['uid']), 'credit'); $space['showcredit'] = intval($space['showcredit']);  
$cookie_name = 'space_top_'.$_GET['view']; if($_SCOOKIE[$cookie_name]) { $now_pos = $_SCOOKIE[$cookie_name]; } else { $now_pos = $_SGLOBAL['db']->result($_SGLOBAL['db']->query("\123\x45\114\x45\x43\124 COUNT(*) \106\122\117\115 ".tname('show')." WHERE credit>'$space[showcredit]'"), 0); $now_pos++; ssetcookie($cookie_name, $now_pos); } } elseif ($_GET['view'] == 'mm') { if($multi_mode) { $c_sql = "\123ELECT COUNT(*) FR\117\115 ".tname('spacefield')." WHERE sex='2'"; } else { $count = 100; $cache_file = S_ROOT.'./data/cache_top_mm.txt'; } $sql = "\123\x45L\105\103\124 \155\141\x69n.*, \146\151\145ld.* \106ROM ".tname('space')." \155a\x69\156, ".tname('spacefield')." f\151\x65\154\144
		WHERE \x66iel\x64.sex='2' AND \146i\x65ld.uid=\155a\x69\156.uid
		ORDER BY \x6dai\156.viewnum DESC";  
$cookie_name = 'space_top_'.$_GET['view']; if($_SCOOKIE[$cookie_name]) { $now_pos = $_SCOOKIE[$cookie_name]; } else { if($space['sex']==2) { $pos_sql = "\x53EL\105C\124 COUNT(*) \106R\117\x4d ".tname('space')." s, ".tname('spacefield')." f WHERE s.viewnum>'$space[viewnum]' AND f.sex='2' AND f.uid=s.uid"; $now_pos = $_SGLOBAL['db']->result($_SGLOBAL['db']->query($pos_sql), 0); $now_pos++; } else { $now_pos = -1; } ssetcookie($cookie_name, $now_pos); } } elseif ($_GET['view'] == 'gg') { if($multi_mode) { $c_sql = "\123\x45L\105\x43\x54 COUNT(*) F\x52O\x4d ".tname('spacefield')." WHERE sex='1'"; } else { $count = 100; $cache_file = S_ROOT.'./data/cache_top_gg.txt'; } $sql = "S\x45\114\x45CT m\x61i\x6e.*, \x66i\x65l\144.* \x46\122\x4fM ".tname('space')." \x6d\x61\x69\x6e, ".tname('spacefield')." \146\x69e\154d
		WHERE field.sex='1' AND fi\x65ld.uid=\x6d\141\151\x6e.uid
		ORDER BY \x6d\141in.viewnum DESC";  
$cookie_name = 'space_top_'.$_GET['view']; if($_SCOOKIE[$cookie_name]) { $now_pos = $_SCOOKIE[$cookie_name]; } else { if($space['sex']==1) { $pos_sql = "\123\105\x4cE\x43\x54 COUNT(*) FR\x4fM ".tname('space')." s, ".tname('spacefield')." f WHERE s.viewnum>'$space[viewnum]' AND f.sex='1' AND f.uid=s.uid"; $now_pos = $_SGLOBAL['db']->result($_SGLOBAL['db']->query($pos_sql), 0); $now_pos++; } else { $now_pos = -1; } ssetcookie($cookie_name, $now_pos); } } elseif ($_GET['view'] == 'credit') { if($multi_mode) { $c_sql = "\123\105\x4c\105\x43\124 COUNT(*) \106R\x4fM ".tname('space'); } else { $count = 100; $cache_file = S_ROOT.'./data/cache_top_credit.txt'; } $sql = "\123\x45\x4cEC\x54 \x6d\x61\x69\x6e.*, fi\145l\x64.* \106\x52\117\x4d ".tname('space')." \155a\151\x6e
		LEFT JOIN ".tname('spacefield')." f\x69\145l\144 \x4f\x4e \x66\151\x65l\x64.uid=\155\141i\156.uid
		ORDER BY \155ai\156.credit DESC";  
$cookie_name = 'space_top_'.$_GET['view']; if($_SCOOKIE[$cookie_name]) { $now_pos = $_SCOOKIE[$cookie_name]; } else { $pos_sql = "\123\105\114\x45\103T COUNT(*) F\x52OM ".tname('space')." s WHERE s.credit>'$space[credit]'"; $now_pos = $_SGLOBAL['db']->result($_SGLOBAL['db']->query($pos_sql), 0); $now_pos++; ssetcookie($cookie_name, $now_pos); } } elseif ($_GET['view'] == 'experience') { if($multi_mode) { $c_sql = "S\x45L\x45\103\124 COUNT(*) \106R\x4fM ".tname('space'); } else { $count = 100; $cache_file = S_ROOT.'./data/cache_top_experience.txt'; } $sql = "\x53ELE\103T \x6da\x69\156.*, fie\154\144.* FR\117M ".tname('space')." \155ai\x6e
		LEFT JOIN ".tname('spacefield')." f\x69el\144 \117\x4e \146i\145\x6cd.uid=\155\141\151\x6e.uid
		ORDER BY ma\151\156.experience DESC";  
$cookie_name = 'space_top_'.$_GET['view']; if($_SCOOKIE[$cookie_name]) { $now_pos = $_SCOOKIE[$cookie_name]; } else { $pos_sql = "\x53\x45\114\x45C\x54 COUNT(*) F\x52\x4f\x4d ".tname('space')." s WHERE s.experience>'$space[experience]'"; $now_pos = $_SGLOBAL['db']->result($_SGLOBAL['db']->query($pos_sql), 0); $now_pos++; ssetcookie($cookie_name, $now_pos); } } elseif ($_GET['view'] == 'friendnum') { if($multi_mode) { $c_sql = "S\105LEC\124 COUNT(*) \106\122\x4fM ".tname('space'); } else { $count = 100; $cache_file = S_ROOT.'./data/cache_top_friendnum.txt'; } $sql = "\x53E\114\x45\x43\x54 m\x61\151\156.*, \x66\151\145ld.* \x46\x52O\x4d ".tname('space')." \155a\151n
		LEFT JOIN ".tname('spacefield')." \x66\151\x65\154\x64 \x4f\116 \x66\x69\x65\x6cd.uid=\x6da\x69\156.uid
		ORDER BY \155ain.friendnum DESC";  
$cookie_name = 'space_top_'.$_GET['view']; if($_SCOOKIE[$cookie_name]) { $now_pos = $_SCOOKIE[$cookie_name]; } else { $pos_sql = "\123\105\x4c\105\x43\124 COUNT(*) F\x52OM ".tname('space')." s WHERE s.friendnum>'$space[friendnum]'"; $now_pos = $_SGLOBAL['db']->result($_SGLOBAL['db']->query($pos_sql), 0); $now_pos++; ssetcookie($cookie_name, $now_pos); } } elseif ($_GET['view'] == 'viewnum') { if($multi_mode) { $c_sql = "S\105L\x45\103\x54 COUNT(*) \106\x52O\115 ".tname('space'); } else { $count = 100; $cache_file = S_ROOT.'./data/cache_top_viewnum.txt'; } $sql = "\x53\x45\x4c\105\x43T \155a\151\x6e.*, fi\145l\x64.* \106\122\117M ".tname('space')." \155\141\x69\x6e
		LEFT JOIN ".tname('spacefield')." f\151\x65\x6c\x64 O\116 \x66\x69\145ld.uid=ma\x69n.uid
		ORDER BY m\x61\151\156.viewnum DESC";  
$cookie_name = 'space_top_'.$_GET['view']; if($_SCOOKIE[$cookie_name]) { $now_pos = $_SCOOKIE[$cookie_name]; } else { $pos_sql = "\x53\x45\114\x45CT COUNT(*) FROM ".tname('space')." s WHERE s.viewnum>'$space[viewnum]'"; $now_pos = $_SGLOBAL['db']->result($_SGLOBAL['db']->query($pos_sql), 0); $now_pos++; ssetcookie($cookie_name, $now_pos); } } elseif ($_GET['view'] == 'online') { $c_sql = "S\x45\114\105\x43\124 COUNT(*) F\122\x4f\115 ".tname('session'); $sql = "\123E\x4c\x45C\124 \146\x69\x65\x6c\x64.*, space.*, \x6da\x69\156.*
		F\122O\115 ".tname('session')." \x6da\x69n USE \111\116\x44\105X (\x6cas\x74\x61\143\x74\x69\166\151\x74\x79)
		LEFT JOIN ".tname('space')." space O\116 space.uid=\155\x61\151\156.uid
		LEFT JOIN ".tname('spacefield')." \146i\x65\x6c\x64 ON \146\151\x65\x6c\144.uid=m\x61\x69n.uid
		ORDER BY \x6d\141\x69\156.\154\141\163\x74a\x63t\x69v\151\x74\171 DESC"; $now_pos = -1; } elseif ($_GET['view'] == 'updatetime') { $c_sql = "SE\x4cE\x43T COUNT(*) F\122\x4f\115 ".tname('space'); $sql = "\123\105\114\105CT \x6d\141i\x6e.*, \x66\x69\x65\154\144.* F\x52\117\115 ".tname('space')." m\x61in USE \111\x4e\x44\105\130 (updatetime)
		LEFT JOIN ".tname('spacefield')." f\x69\x65\154\144 \117\116 f\x69e\x6cd.uid=\x6d\141in.uid
		ORDER BY \x6d\141\151n.updatetime DESC"; $now_pos = -1; } $list = array(); if(empty($count)) { $cache_mode = false; $count = empty($_SCONFIG['networkpage'])?1:$_SGLOBAL['db']->result($_SGLOBAL['db']->query($c_sql),0); $multi = multi($count, $perpage, $page, "space.\x70h\160?d\x6f=\164o\160&view=$_GET[view]"); } else { $cache_mode = true; $multi = ''; $start = 0; $perpage = $count; if($cache_file && file_exists($cache_file) && $_SGLOBAL['timestamp'] - @filemtime($cache_file) < $cache_time*60) { $list_cache = sreadfile($cache_file); $list = unserialize($list_cache); } } if($count && empty($list)) { $query = $_SGLOBAL['db']->query("$sql LIMIT $start,$perpage"); while ($value = $_SGLOBAL['db']->fetch_array($query)) { $list[$value['uid']] = $value; } if($cache_mode && $cache_file) { swritefile($cache_file, serialize($list)); } } foreach($list as $key => $value) { $value['isfriend'] = ($value['uid']==$space['uid'] || ($space['friends'] && in_array($value['uid'], $space['friends'])))?1:0; realname_set($value['uid'], $value['username'], $value['name'], $value['namestatus']); $fuids[] = $value['uid']; $list[$key] = $value; }  
$ols = array(); if($fuids) { $query = $_SGLOBAL['db']->query("\x53\105L\x45\x43\124 * \106\x52OM ".tname('session')." WHERE uid IN (".simplode($fuids).")"); while ($value = $_SGLOBAL['db']->fetch_array($query)) { if(!$value['magichidden']) { $ols[$value['uid']] = $value['lastactivity']; } elseif ($_GET['view'] == 'online' && $list[$value['uid']]) { unset($list[$value['uid']]); } } } $actives = array($_GET['view'] => ' class="active"'); include_once template("space_top");  ?>
